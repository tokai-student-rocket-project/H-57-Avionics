# H-57 搭載計器 解析資料

![Banner](./Images/Banner.png)

## 共通計器

※次期搭載計器では、従来の共通計器とテレメータを統合し「搭載計器(Avionics)」と呼称する。搭載計器はモジュール式で開発を行い、共通計器は飛翔管理モジュールと計測モジュール、テレメータは通信モジュール、バルブコントローラはTHR制御モジュールとする。

回収したデータはこちら  
SDカード [flight.csv](./Log/flight.csv)  
EEPROM [flight_eeprom_raw_recovered.txt](./Log/flight_eeprom_raw_recovered.txt)  
地上局 [ground.txt](./Log/ground.txt)

### 到達高度

速報値: __416.68m__ (X+9.22[sec])  
解析値: __402.14m__ (X+9.22[sec])

解析値は打ち上げ当日の海面気圧及び、該当高度の気温から以下の式を用いて到達高度を求めた。

$$ h=\frac{((\frac{P_{0}}{P})^{\frac{1}{5.257}}-1)\times(T+273.15)}{0.0065} $$

$$ P = 97279.27\text{[Pa] (測定値)} \\ P_{0} = 102340\text{[Pa] (海面気圧, ※1)} \\ T = -3.5\text{[degC] (ジオポテンシャル高度406mでの気温, ※2)} $$

- ※1 [毎日の全国データ一覧表（日別値:2023年03月04日）](https://www.data.jma.go.jp/obd/stats/data/mdrr/synopday/data7.html)
- ※2 [気温・湿度の観測データ(札幌　2023年3月4日9時)](https://www.data.jma.go.jp/obd/stats/etrn/upper/view/daily_uth.php?year=2023&month=3&day=4&hour=9&atm=&point=47412&view=)

![Altitude](./Images/Altitude.png)

### 頂点検知

分離ロジックは以下の二つのパターンがある。

- タイマーによる強制分離
- 頂点検知による通常分離

今回の分離は__タイマーによる強制分離 (X+9.98, 頂点の0.76秒後)__ であった。

通常分離が行えなかった理由としては、以下で説明する平滑化の強度が弱く、頂点検知が遅れたことで、安全機構として組み込んだ強制分離が先に動作した。

#### 平滑化について

頂点検知は以下の手順で行われる。

気圧計測 > 高度算出 > 平滑化 > 10回連続降下検知

このうち、平滑化では任意の平滑化定数 a が必要であり、これが頂点検出の感度に影響する。今回は*__よくわからんので適当__*に a=0.25 とした。

結果としては X+11.09[sec] (頂点の1.87秒後) で連続降下検知数が10を上回っており、強制分離を考慮しない場合、この時間に通常分離が行われていた。

以下の図は高度変化と連続降下検知数を表している。左のH-57搭載モデルではX+11.09[sec] (頂点の1.87秒後)に頂点検知が行われている。右の検知感度を改善したモデルではX+9.57[sec] (頂点の0.35秒後)に頂点検知が行われる。今後の打ち上げでは、改善後のモデルを使うことで、より精度の高い頂点検知を期待できる。

|H-57搭載モデル|感度改善モデル|
|:-:|:-:|
|a = 0.25|a = 0.5|
|閾値 = 10回|閾値 = 5回|
|![ApogeeDetectionBefore](./Images/ApogeeDetectionBefore.png)|![ApogeeDetectionAfter](./Images/ApogeeDetectionAfter.png)|

### 終端速度

終端速度: __14~15[m/s]__ (垂直成分のみ)

サンプル間の高度変化を時間変化で割ることで求めた。

詳細は[こちら | VerticalVelocity.csv](./Analysis/VerticalVelocity.csv)

![verticalVelocity](./Images/VerticalVelocity.png)

### 気温

フライトデータでは、気温の測定値が20degC付近を推移している。これは明らかに外気温との乖離がある。

![Temperature](./Images/Temperature.png)

リフトオフ直後の20.5degCから僅かに上昇し続け、分離後からは減少していることがわかる。

原因としては、太陽光によってチューブが温められたことが考えられる。打ち上げ当時の射点は気温が0degC程度で日差しが強い環境であった。電装チューブはほぼ密閉された状態であり、基板に搭載した気温センサが外気温を計測することができなかったと考えられる。

また、気温センサの応答性が低いという問題もある。分離後にチューブ内に外気が流入したことで計測値は減少しているが、応答性はかなり低いことがわかる。

解析時の動作試験では気温センサは正常に動作したが、やはり応答性が低いことを確認した。

今後の改善点としては、機体外に熱電対を露出させる方法がある。

### 速度・変位

加速度を座標変換したのち積分することで速度と変位を求めた。なお、オープニングショックによってセンサの測定域を振り切れていた10.96[s]~11.99[s]の加速度は無視している。

以下は算出方法である。

回収した加速度, ジャイロを元にクオータニオンを算出して各軸の重力加速度を求めた。

![Quaternion](./Images/Quaternion.png)

![Gravity](./Images/Gravity.png)

次に、加速度から重力加速度を除去した。

|除去前|除去後|
|-|-|
|![Gravity](./Images/Acceleration.png)|![Gravity](./Images/AccelerationGravityRemoved.png)|

クオータニオンを用いてセンサ座標系として計測された加速度をグローバル座標系に座標変換を行った。

最後に、グローバル座標系の加速度を積分することで、速度と変位を求めた。

![Speed](./Images/WorldSpeed.png)

![Position](./Images/WorldPosition.png)

開傘時の加速度を無視している影響で、Y軸方向の減速が反映されず、ダウンレンジが異常に長くなってしまっている。

一方で、Z軸方向の変位は気圧から算出した高度と大きな差がないことから、比較的正確なのではないかと考える。

![AltitudeAccPress](./Images/AltitudeAccPress.png)

__まとめ__

加速度からの速度・変位算出は、納得のできる値を出すことができなかった。このような結果となった要因としては、オープニングショックの影響、地磁気計測をしていないことによるクオータニオン算出の精度不足、解析者の力不足により適切なフィルタ処理が行えなかったことが挙げられる。次期搭載計器では、オープニングショックでも振り切れない高G対応の加速度センサを使うこと、地磁気センサを使うことで精度の改善を目指す。

### SDカード

全てのフライトデータの回収に成功した。

[flight.csv](./Log/flight.csv)  

![SD](./Images/SD.png)

### EEPROM

EEPROMからはX+15.20[sec]以降のデータ読み出しができなかった。(解決済み)

![EEPROM](./Images/EEPROM.jpg)

そこで、EEPROMを全てブレッドボードに移してデータダンプを試みた。

![DataDumping](./Images/DataDumping.jpg)

[flight_eeprom_raw.txt](./Log/flight_eeprom_raw.txt)

バイナリデータはMsgPack規格に準拠している。

710行目 (X+15.199[sec])  
`8 12 CA 41 73 2F 1B 4 16 1 CA 47 BF 6C 70 CA 41 A2 66 66 CA 43 B1 19 8C 7E CA 3E B3 80 4 CA 3E 11 1 5 CA 3F 35 20 2D CA 42 8C DA 89 CA 41 90 63 E7 CA C3 8C EA 25 CA 43 36 A5 B2 CA 42 89 76 B5 CA C2 D2 35 43 CA 40 53 12 FE CA 40 9B 83 33 CA 41 3C 76 2 D 0`  

711行目 (X+15.221[sec])  
`8 12 CA 41 73 89 37 4 17 1 CA 47 BF 6E 32 CA 41 A2 51 EC CA 43 B0 F3 20 CC 7F CA 3E CE 40 4 CA 3E 69 1 4 CA 3F 3A 1 2D CA 42 80 A8 96 CA 41 E6 BB 51 CA C3 92 1 90 CA 43 37 DB F8 CA 42 83 AD D6 CA C2 CE A9 14 CA 40 53 12 FE CA 40 9B F1 6 CA 41 3C 76 2 3E`

解析の結果、X+15.221[sec]以降は1パケットのサイズが大きくなっており、パケットの区切りを示す`0x00`のビットが認識されなかったことがわかった。保存は正常に行えていたため、上記を修正したことで全てのフライトデータ回収に成功した。

[flight_eeprom_raw_recovered.txt](./Log/flight_eeprom_raw_recovered.txt)

## バルブコントロールモジュール

### 動作角度/動作速度について

今回、ATMEGA328Pでのみ使用できる"VarSpeedServo.h"を用いて角度の制御を行った。
燃焼実験を通して角度の微調節を行った結果、H-57号機で打ち上がった時のLaunchMode/WaitingModeのコンフィグは、以下のように設定した。

**Launch Mode**

|バルブ|角度|速度|
|---|---|---|
|供給用|80|60|
|主流路|57|50|


**Waiting Mode**

|バルブ|角度|速度|
|---|---|---|
|供給用|20|30|
|主流路|20|30|

ボールバルブは90度での開閉を行うためコンフィグの角度の設定に80や20が設定されることに疑問を持つかもしれないが、これはArduino NANOが生み出すPWMの幅とアクチュエーターが持つPWMの幅に差異がある為である。

できる限り差異が起きないように対処したが今の堤には不可能だったためArduino言語で初期設定されているPWMを利用しコンフィグ設定を行った。


### バルブの動作について
燃焼実験時と打上げ実験時の動作を比べてみると、供給用バルブが閉栓してから主流路用バルブが開栓するため点火シークエンス開始 T+0.0~0.5s 間に飛翔を確認した。

そのため、バルブの動作としては期待通りに動作を確認することが出来た。

加えて、打上げ後のバルブの状態を確認したところ開栓状態であることも確認出来たためバルブコントロールモジュールの機能としては満足のいく結果となった。

![打上げ後のバルブ](../Telemeter/images/H-57_Ballvalve_Launched.jpg "写真中央を観察すると、ボールバルブが開栓状態になっていることが確認できる。")

**まとめ**

PWMを用いたボールバルブの制御の実証は成功を納めた。
しかしながら、ボールバルブの開閉検知に物理スイッチを用いなかった点とRS485という通信方式を用いた位置制御の方が制御方式が容易であることを打上げ直前に知った点が反省点として残る。
まずは、この2点を燃焼実験時に実証できるように開発を進めていきたい。

## 電源

搭載計器の電源は内部電源と外部電源に分類され、外部電源接続時は外部電源の消費が優先される。

電源配線は後述する2つの方式がある。

__方式1__

- 機体組み時点では両電源は接続されていない
- 電源投入で両電源を接続する（外部電源を消費）
- アンビリカルケーブル離脱で内部電源に切り替え
- (撤収時は両電源を外す)

![Power1](./Images/Diagram/Power1.drawio.png)

__方式2__

- 機体組み時に内部電源を接続
- 内部電源消費を防ぐために外部電源に外部バッテリーを接続
- 電源投入で外部電源を外部バッテリーから安定化電源に切り替え
- アンビリカルケーブル離脱で内部電源に切り替え
- (撤収時は外部電源を外す)

![Power1](./Images/Diagram/Power2.drawio.png)

当初は方式1を運用していたが、方式1は内部電源操作を機体組み後も行う必要があり、内部電源配線が機体後方のバルブカプラまで伸びていた。これにより、飛翔中の振動や衝撃により瞬電を起こす懸念があり、2/28リハは方式2で運用した。

しかし、方式2はシークエンス中の内部電源消費が大きく、供給電圧が低下したことで撤収時にはボールバルブのサーボが低電圧特有の挙動（勝手に開閉を繰り返す）を示したため、以降は方式1に戻して運用を行った。

方式1で打ち上げを行ったが、結果的には懸念していた飛翔中の瞬電は起こらなかった。

### 電源消費

リハの撤収後に毎回電池を新品に交換した。電池離脱対策として布絶縁テープを一周巻くのに加え、基板全体をタイラップで巻いた。

電池交換後の電池ボックス基板の出力電圧は15~16V。翌朝の機体組みまで電池ボックス基板は変圧基板に接続しなかった。

シークエンス中の電源投入でも内部電源電圧は15~16Vを維持していた。

### 内部/外部電源切り替え

H-57号機では内部/外部電源切り替え回路の検証を打上げ/大学での実験含めて始めて実施した。
H-57号機に搭載した電源基板についての情報をここに共有する。

- [ハイブリッドロケットの電源供給及び設備に関する技術ドキュメント](../FlightResult/Power/ハイブリッドロケットの電源供給及び設備に関する.pdf)

内部/外部切り替え回路については以下を参照して欲しい。
![切り替え](../Power/images/Powerswitch.png)
技術ドキュメントP.6に記載されている。

EXT PSが外部電源、INT PSが内部電源となっている。今回、懸念点のあった個所は機体打上げ時に外部からの給電が無くなった場合に瞬間的に電源が落ちる可能性があるか。であった。

打ち上げ前に大学で動作確認したところ、瞬間的に電源が落ちる事象は確認出来なかったが現地での動作が果たして大学での動作と同じようになるか不安であったが問題なく動作したことを確認できた。

これは、懸念点の対策かつ3端子レギュレーター保護回路部に搭載されているコンデンサーに電位が蓄えれらたため電源切り替えの途中でもコンデンサーに蓄えられた電位を用いて電源切り替え完了まで電圧を保つことが出来たためであると考えられる。

__まとめ__

電源モジュールは2022年度に4年生であった先輩が設計し、H-57号機から初めて搭載したが技術ドキュメント通りの動作を確認することができ安心している。
60×60の位置に穴がある基板であれば搭載することは可能であるため新入生の教育用の機体や、回路図、ボード図の説明を行いながらエレキの理解を深めていく教育用基板としても最適なモジュールとなっているため部品の在庫を確保していきながら継承をしていく。

また、LTC4416を用いた内部/外部電源切り替え回路の動作検証は成功ということとなる。
今後も、内部/外部電源切り替えを行うことが予想されるためこの回路を引継ぎながらもさらなる最適化を進めていきたい。

## ハードウェア

### 損傷

基板や実装部品, コネクタ等に損傷は見られなかった。

|ラグの左側|ラグ側|ラグの対面|ラグの右側|
|---|---|---|---|
|![Avionics1](./Images/Avionics1.jpg)|![Avionics2](./Images/Avionics2.jpg)|![Avionics3](./Images/Avionics3.jpg)|![Avionics4](./Images/Avionics4.jpg)|

他の向きの写真は[こちら](./Images/Board/)

||打ち上げ前|回収後|
|:-|:-:|:-:|
|テレメータ|![T1](./Images/Board/Before/Telemeter/T1.jpg)|![T1](./Images/Board/After/Telemeter/T1.jpg)|
|バルブコントローラ|![V1](./Images/Board/Before/ValveControler/V1.jpg)|![V1](./Images/Board/After/ValveControler/V1.jpg)|
|電源|![P1](./Images/Board/Before/Power/P1.jpg)|![P1](./Images/Board/After/Power/P1.jpg)|
|共通計器|![C1](./Images/Board/Before/CommonInstruments/C1.jpg)|![C1](./Images/Board/After/CommonInstruments/C1.jpg)|
|電池ボックス|![B1](./Images/Board/Before/Battery/B1.jpg)|![B1](./Images/Board/After/Battery/B1.jpg)|

計器下のベークライト板に損傷を確認した。

ベークライト板の破壊によって計器への衝撃が緩和された可能性がある。

今後は、板材を強度の高いものに変更するか、計器タワーの上下を固定するなど構造的な改善を行う必要がある。

![DamegedBakelite](./Images/DamagedBakelite.jpg)

### アンビリカルケーブル

当初、アンビリカルケーブルの引抜力はバネばかりを用いて 2.10×9.81 = 20.601[N] であることが実験により確認できたため、ランチャからの着脱に関して大きな問題になることはないと考えていた。これは、H-57号機に搭載するロケットエンジンであるTHR-F810Lの推力が理論値では600N程度だからである。

実際、H-57号機打上げの際には想定通りの動作を行うことが出来た。

外部給電はアンビリカルケーブルで行った。離床時にコネクタ部分で解放され、同時に内部電源に切り替わる設計である。地上での試験と同様、電源切り替え時の瞬電は起こらなかった。

### フライトピン

フライトピン, アンビリカルケーブルともに線の破断はなく、コネクタ部分から解放されていた。コネクタの破損もないことを確認した。

**まとめ**

アンビリカルケーブルを搭載することに関して、手元に資料がなかったため他団体やロケットガール＆ボーイ履修生の話を参考にしながら設計を進めてきたが、とても満足のいく結果となった。
今後も内部/外部電源切り替え回路を搭載する場合はアンビリカルケーブルは必須となってくるため配線の本数を少なくすることや運用のしやすさに重きを置き設計を行っていく。

![Liftoff](./Images/Liftoff.gif)

## 無線通信

アップリンクでの分離コンフィグ設定は成功した。

### 電波強度

地上局の受信強度RSSIは以下の通りである。

||最小[dBm]|最大[dBm]|
|---|---|---|
|離床前|-95|-91|
|着地前|-117|-94|

いずれの強度でも問題なくダウンリンクを受信することができた。

## 地上局

### GNSS

GNSSは当初、大きな加速度がかかると振り切れる為に位置情報を取得不可能になるという懸念事項があった。
地上局で取得したデータより[GNSSlog](../Telemeter/Analysis/GNSSlog.txt)を確認すると、65行と66行の間でsatellitesの数が12.0から7.0に減少している箇所がありこの付近から[GNSSの示す位置情報](../Telemeter/images/H-57GNSSlog.png)が通常ありえない位置を示していることが分かる。そのためこの間に懸念していた位置情報の取得が不可能になっている時間だと言える。
GNSSの示す位置情報については下記の写真を参考にしていただけると幸いである。

加えて、この写真の11:42:49付近に注目してみるとパラシュート展開後、機体が東の方へ流されていることがわかる。

![GNSS](../Telemeter/images/H-57GNSSlog.png "GNSSログ")

では、位置情報取得までの復帰時間を考察すると、赤色のポイントが示す位置が離床前の位置情報となっており、青色のポイントが示す位置が離床後の位置情報となっている。[GNSSlog](../Telemeter/Analysis/GNSSlog.txt)の66行目から71行目の間を取得不可時間と考えるとその時間は11:42:36~11:42:43の8秒間（epochTimeより算出）であることが分かる。また、H-57号機が打ちあがった時間は11:42:33であることからも確かにその8秒間は位置情報取得不可時間であることへの裏付けとなる。

**まとめ**

始めてGNS関連の設計を行ったがまずは無事に機体を見つけることが出来て満足のいく結果となった。
反省点として、1Hz程度でしか位置情報を受信出来なかった為、10Hz程度で受信をできるようにしていきたい。

---

＿＿＿*いかがでしたか？*
